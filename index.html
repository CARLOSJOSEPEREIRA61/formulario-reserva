<!DOCTYPE html>
<html lang="pt-BR">
<head>
  <meta charset="UTF-8" />
  <title>Reserva e Ocupação</title>
  <style>
    body { font-family: Arial, sans-serif; max-width: 600px; margin: 40px auto; }
    label { display: block; margin-top: 15px; }
    input, select, button { width: 100%; padding: 8px; margin-top: 5px; }
    table { width: 100%; border-collapse: collapse; margin-top: 30px; }
    th, td { border: 1px solid #999; padding: 6px; text-align: center; }
    th { background-color: #eee; }
    #mensagem { margin-top: 20px; font-weight: bold; }
  </style>
</head>
<body>

  <h2>Reserva de UH</h2>

  <form id="reservaForm">
    <label for="checkin">Data de Check-in:</label>
    <input type="date" name="checkin" id="checkin" required />

    <label for="checkout">Data de Check-out:</label>
    <input type="date" name="checkout" id="checkout" required />

    <label for="uh">Unidade Habitacional (UH):</label>
    <select name="uh" id="uh" required>
      <option value="">-- Selecione a UH --</option>
      <option>01 Amora Mel</option>
      <option>02 Francisco</option>
      <option>03 Luna</option>
      <option>04 Teca</option>
      <option>05 Bento</option>
      <option>06 Luca</option>
      <option>07 Augusto</option>
      <option>08 Marie Lili</option>
      <option>09 Leo</option>
      <option>10 Nino</option>
      <option>11 Tony</option>
      <option>12 Kiko</option>
      <option>13 Anita</option>
      <option>14</option>
      <option>15</option>
      <option>16</option>
      <option>17</option>
      <option>18</option>
      <option>19</option>
      <option>20</option>
    </select>

    <label for="origem">Origem da Reserva:</label>
    <select name="origem" id="origem" required>
      <option value="">-- Selecione a origem --</option>
      <option>1 AirBnB</option>
      <option>2 Booking</option>
      <option>3 Avulso</option>
    </select>

    <button type="submit">Enviar Reserva</button>
  </form>

  <div id="mensagem"></div>

  <h2>Visualização da Ocupação (REG)</h2>
  <table id="tabelaOcupacao">
    <thead><tr id="headerRow"></tr></thead>
    <tbody id="bodyRows"></tbody>
  </table>

<script>
  const urlBase = "https://script.google.com/macros/s/AKfycbwxHznnpmB9I_meA2cAgIxLkF0B9n4j402LDo_j_BNxeMjQF0PVpObQqx8Rbp1Nz7_ZCw/exec";
  const urlPost = urlBase;
  const urlGet = urlBase + "?action=lerRangeDinamico";

  const form = document.getElementById("reservaForm");
  const mensagem = document.getElementById("mensagem");
  const headerRow = document.getElementById("headerRow");
  const bodyRows = document.getElementById("bodyRows");

  // Ajuste das datas mínima para checkin e checkout
  const checkin = document.getElementById("checkin");
  const checkout = document.getElementById("checkout");
  const hoje = new Date();
  checkin.min = hoje.toISOString().split('T')[0];
  checkin.addEventListener("change", () => {
    if (checkin.value) {
      const d = new Date(checkin.value);
      d.setDate(d.getDate() + 1);
      checkout.min = d.toISOString().split("T")[0];
      if (checkout.value <= checkin.value) checkout.value = "";
    }
  });

  form.addEventListener("submit", (e) => {
    e.preventDefault();
    mensagem.textContent = "";
    const formData = new FormData(form);
    fetch(urlPost, {
      method: "POST",
      body: new URLSearchParams(formData)
    })
    .then(res => res.json())
    .then(json => {
      if (json.status === "success") {
        mensagem.textContent = json.message;
        mensagem.style.color = "green";
        form.reset();
        carregarOcupacao();
      } else {
        mensagem.textContent = json.message || "Erro ao salvar.";
        mensagem.style.color = "red";
      }
    })
    .catch(() => {
      mensagem.textContent = "Erro ao enviar reserva.";
      mensagem.style.color = "red";
    });
  });

  function carregarOcupacao() {
    fetch(urlGet)
      .then(res => res.json())
      .then(json => {
        if (json.status === "success") {
          montarTabela(json.data);
        } else {
          mensagem.textContent = json.message || "Erro ao carregar ocupação.";
          mensagem.style.color = "red";
        }
      })
      .catch(() => {
        mensagem.textContent = "Erro ao carregar ocupação.";
        mensagem.style.color = "red";
      });
  }

  function montarTabela(dados) {
    headerRow.innerHTML = "";
    bodyRows.innerHTML = "";

    if (!dados.length) {
      mensagem.textContent = "Nenhum dado de ocupação disponível.";
      return;
    }

    // Criar cabeçalho: UH1, UH2, ... UH20 (considerando 20 colunas)
    for (let i = 1; i <= dados[0].length; i++) {
      const th = document.createElement("th");
      th.textContent = `UH${i}`;
      headerRow.appendChild(th);
    }

    // Criar linhas com os dados
    dados.forEach(linha => {
      const tr = document.createElement("tr");
      linha.forEach(celula => {
        const td = document.createElement("td");
        td.textContent = celula;
        tr.appendChild(td);
      });
      bodyRows.appendChild(tr);
    });
  }

  // Carrega dados na inicialização da página
  carregarOcupacao();
</script>

</body>
</html>

const SPREADSHEET_ID = "1Jnsj-VHyPntKk0D2SciUFaSvlFiP5xqxllsg0F0OxPI"; // ID da planilha

function doPost(e) {
  try {
    const ss = SpreadsheetApp.openById(SPREADSHEET_ID);
    const sheet = ss.getSheetByName("Sheet1");

    const [ano, mes, dia] = e.parameter.checkin.split('-').map(Number);
    const checkin = new Date(ano, mes - 1, dia, 12); // meio-dia para evitar problema de fuso

    const checkout = e.parameter.checkout;
    const uh = e.parameter.uh;
    const origem = e.parameter.origem;

    const dataEnvio = new Date();

    const chave = Utilities.formatDate(checkin, Session.getScriptTimeZone(), "dd/MM/yyyy") + uh.slice(0, 2);
    const repeticao = checkout;
    const codigo = origem.slice(0, 1);

    sheet.appendRow([
      chave,
      dataEnvio,
      Utilities.formatDate(checkin, Session.getScriptTimeZone(), "yyyy-MM-dd"),
      checkout,
      uh,
      repeticao,
      codigo
    ]);

    return ContentService
      .createTextOutput(JSON.stringify({ status: "success", message: "Reserva gravada com sucesso." }))
      .setMimeType(ContentService.MimeType.JSON);

  } catch (error) {
    return ContentService
      .createTextOutput(JSON.stringify({ status: "error", message: error.message }))
      .setMimeType(ContentService.MimeType.JSON);
  }
}


function doGet(e) {
  try {
    if (e.parameter.action === "lerRangeDinamico") {
      const ss = SpreadsheetApp.openById(SPREADSHEET_ID);
      const sheet = ss.getSheetByName("REG");
      if (!sheet) throw new Error("Aba REG não encontrada");

      const hoje = new Date();
      hoje.setHours(0, 0, 0, 0);
      const ontem = new Date(hoje);
      ontem.setDate(ontem.getDate() - 1);

      const dataFinal = new Date(ontem);
      dataFinal.setDate(dataFinal.getDate() + 35);

      const lastRow = sheet.getLastRow();
      const datasColA = sheet.getRange(1, 1, lastRow).getValues().flat();

      let startRow = null;
      let endRow = null;

      for (let i = 0; i < datasColA.length; i++) {
        let cellDate = datasColA[i];
        if (!(cellDate instanceof Date)) continue;
        if (startRow === null && cellDate >= ontem) {
          startRow = i + 1;
        }
        if (cellDate > dataFinal) {
          endRow = i;
          break;
        }
      }

      if (startRow === null) {
        return ContentService.createTextOutput(JSON.stringify({
          status: "error",
          message: "Nenhuma data encontrada para o intervalo solicitado"
        })).setMimeType(ContentService.MimeType.JSON);
      }

      if (endRow === null) endRow = lastRow;
      const numLinhas = endRow - startRow + 1;

      const rangeDados = sheet.getRange(startRow, 7, numLinhas, 20); // col G a Z
      const dados = rangeDados.getDisplayValues();

      return ContentService
        .createTextOutput(JSON.stringify({ status: "success", data: dados }))
        .setMimeType(ContentService.MimeType.JSON);
    }

    return ContentService
      .createTextOutput(JSON.stringify({ status: "error", message: "Parâmetro action inválido" }))
      .setMimeType(ContentService.MimeType.JSON);

  } catch (error) {
    return ContentService
      .createTextOutput(JSON.stringify({ status: "error", message: error.message }))
      .setMimeType(ContentService.MimeType.JSON);
  }
}
